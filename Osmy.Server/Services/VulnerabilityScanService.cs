using Microsoft.EntityFrameworkCore;
using Osmy.Server.Data;

namespace Osmy.Server.Services
{
    internal class VulnerabilityScanService : BackgroundService
    {
        //private readonly IAppNotificationService _appNotificationService;

        public VulnerabilityScanService(/*IAppNotificationService appNotificationService*/)
        {
            //_appNotificationService = appNotificationService;
        }

        protected override Task ExecuteAsync(CancellationToken stoppingToken)
        {
            var autoScanTask = Task.Run(() => StartAutoScanRequest(stoppingToken), stoppingToken);
            return autoScanTask;
        }

        public static async Task ScanAsync(long sbomId, CancellationToken cancellationToken = default)
        {
            var scanner = new VulnerabilityScanner();
            await scanner.ScanAsync(sbomId, cancellationToken);
        }

        public static async Task ScanAsync(int sbomId, CancellationToken cancellationToken = default)
        {
            var scanner = new VulnerabilityScanner();
            await scanner.ScanAsync(sbomId, cancellationToken);
        }

        private static async Task StartAutoScanRequest(CancellationToken stoppingToken)
        {
            while (true)
            {
                try
                {
                    var scanner = new VulnerabilityScanner();
                    await scanner.ScanAllAsync(stoppingToken);

                    var appNotificationService = new AppNotificationService();
                    appNotificationService.NotifyVulnerability();
                }
                catch (Exception ex)
                {
                    // TODO logging
                }

                await Task.Delay(Settings.Common.VulnerabilityScanInterval, stoppingToken);
            }
        }
    }
}
