<UserControl x:Class="Osmy.Gui.Controls.VulnerabilityView"
             xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="using:Osmy.Gui.Controls"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:md="https://github.com/whistyun/Markdown.Avalonia"
             xmlns:osv="using:OSV.Schema"
             d:DesignHeight="450" d:DesignWidth="800"
             x:DataType="osv:Vulnerability"
             mc:Ignorable="d">
  <UserControl.Resources>
    <controls:UrlToHostConverter x:Key="urlToHostConverter" />
  </UserControl.Resources>

  <Grid Margin="0,0,15,0">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <StackPanel Grid.Row="0">
      <HeaderedContentControl Content="{Binding Id}" Header="ID" />
      <ItemsControl ItemsSource="{Binding Aliases}">
        <ItemsControl.ItemTemplate>
          <DataTemplate>
            <TextBlock Text="{Binding}" />
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </StackPanel>

    <StackPanel Grid.Row="1">
      <HeaderedContentControl Grid.Row="1"
                              Content="{Binding Summary}"
                              Header="Summary" />
    </StackPanel>

    <StackPanel Grid.Row="2">
      <TextBlock Text="Severity" TextDecorations="Underline" />
      <ItemsControl ItemsSource="{Binding Severity}">
        <ItemsControl.ItemTemplate>
          <DataTemplate>
            <TextBlock TextWrapping="Wrap">
              [<Run Text="{Binding Type}" />] <Run Text="{Binding Score}" />
            </TextBlock>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </StackPanel>

    <StackPanel Grid.Row="3">
      <TextBlock Text="Details" TextDecorations="Underline" />
      <!--
        TODO: 定義済みスタイルを参考に，なじむスタイルを作成
        https://github.com/whistyun/Markdown.Avalonia/blob/master/Markdown.Avalonia.Tight/StyleCollections/MarkdownStyleGithubLike.axaml
      -->
      <md:MarkdownScrollViewer Markdown="{Binding Details}" MarkdownStyleName="GithubLike" />
    </StackPanel>

    <StackPanel Grid.Row="4" Margin="0,5,0,0">
      <TextBlock Classes="AccentText" Text="Affected" />
      <ItemsControl ItemsSource="{Binding Affected}">
        <ItemsControl.ItemTemplate>
          <DataTemplate>
            <HeaderedContentControl Classes="GroupBox">
              <HeaderedContentControl.Header>
                <WrapPanel Margin="2,0,0,2" Orientation="Horizontal">
                  <TextBlock VerticalAlignment="Center"
                             FontWeight="Bold"
                             Text="{Binding Package.Name}" />
                  <TextBlock Margin="5,0,0,0"
                             VerticalAlignment="Center"
                             Text="{Binding Package.Purl, StringFormat=({0})}" />
                </WrapPanel>
              </HeaderedContentControl.Header>

              <HeaderedContentControl.Content>
                <StackPanel>
                  <!--<ItemsControl Margin="2" Items="{Binding Ranges}">
                                          <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                              <Border Margin="0,2,2,2" Padding="3,0"
                                                      Background="LightGray"
                                                      BorderThickness="1" CornerRadius="3">
                                                <StackPanel>
                  -->
                  <!--<TextBlock Text="{Binding Type}" />-->
                  <!--
                  -->
                  <!--<TextBlock Text="{Binding Repo}" />-->
                  <!--
                                                  <ItemsControl Items="{Binding Events}">
                                                    <ItemsControl.ItemTemplate>
                                                      <DataTemplate>
                                                        <TextBlock>
                  -->
                  <!--&lt;=<Run Text="{Binding Limit}" /><LineBreak />-->
                  <!--
                                                          <Run Text="{Binding Introduced}" />
                                                          ~<Run Text="{Binding Fixed}" />
                                                        </TextBlock>
                                                      </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                  </ItemsControl>
                                                </StackPanel>
                                              </Border>
                                            </DataTemplate>
                                          </ItemsControl.ItemTemplate>

                                          <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                              <WrapPanel Orientation="Horizontal" />
                                            </ItemsPanelTemplate>
                                          </ItemsControl.ItemsPanel>
                                        </ItemsControl>-->
                  <ItemsControl Margin="2" ItemsSource="{Binding Versions}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Margin="0,2,2,2" Padding="3,0"
                                Background="LightGray"
                                BorderThickness="1" CornerRadius="3">
                          <TextBlock Text="{Binding}" />
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>

                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal" />
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                  </ItemsControl>
                </StackPanel>
              </HeaderedContentControl.Content>
            </HeaderedContentControl>
          </DataTemplate>
        </ItemsControl.ItemTemplate>

        <ItemsControl.Styles>
          <Style Selector="HeaderedContentControl">
            <Setter Property="Margin" Value="0 0 0 5" />
          </Style>
          <!--  TODO nth-last-childは11.0.0-preview5ではAvaloniaの不具合で動作しない？正式リリース後に動作を確認  -->
          <!--  https://github.com/AvaloniaUI/Avalonia/pull/10055  -->
          <Style Selector="ItemsControl HeaderedContentControl:nth-last-child(1)">
            <Setter Property="Margin" Value="0" />
          </Style>
        </ItemsControl.Styles>
      </ItemsControl>
    </StackPanel>

    <Expander Grid.Row="5" Margin="0,5,0,0">
      <Expander.Header>
        <TextBlock Text="References" />
      </Expander.Header>

      <Expander.Content>
        <ItemsControl ItemsSource="{Binding References}">
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <TextBlock Background="Transparent"
                         TextWrapping="Wrap"
                         ToolTip.Tip="{Binding Url}">
                <!--<Hyperlink NavigateUri="{Binding Url}" RequestNavigate="Hyperlink_RequestNavigate">-->
                <Run Text="{Binding Url, Converter={StaticResource urlToHostConverter}, Mode=OneWay}" />
                <!--</Hyperlink>-->
              </TextBlock>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </Expander.Content>
    </Expander>
  </Grid>
</UserControl>
